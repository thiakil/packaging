From 8c4d0f4b928053b5b058aa5d2c0bafd065e06e63 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sat, 29 Sep 2012 15:11:37 +0200
Subject: [PATCH 152/285] libmyth: Prevent a SEGV when a database connection
 warning dialog is closed

MythContextPrivate::ShowConnectionFailurePopup displays a dialog box
to warn of a database connection failure.  If the connection is
subsequently re-established after the user clicks OK then
MythContextPrivate::HideConnectionFailurePopup can call the virtual
method Close on a deleted object.

This patch adds a synchronous handlder for the dialog destroyed signal
and removes the dangling reference.

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmyth/mythcontext.cpp |    7 ++++---
 mythtv/libs/libmyth/mythcontext.h   |    2 +-
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/mythtv/libs/libmyth/mythcontext.cpp b/mythtv/libs/libmyth/mythcontext.cpp
index 8d9bc38..317bf26 100644
--- a/mythtv/libs/libmyth/mythcontext.cpp
+++ b/mythtv/libs/libmyth/mythcontext.cpp
@@ -1240,8 +1240,9 @@ void MythContextPrivate::ShowConnectionFailurePopup(bool persistent)
 
     if (HasMythMainWindow() && m_ui && m_ui->IsScreenSetup())
     {
-        MBEconnectPopup = ShowOkPopup(
-            message, m_sh, SLOT(ConnectFailurePopupClosed()));
+        MBEconnectPopup = ShowOkPopup(message);
+        QObject::connect(MBEconnectPopup, SIGNAL(destroyed(QObject*)),
+            m_sh, SLOT(ConnectFailurePopupClosed(QObject*)), Qt::DirectConnection);
     }
 }
 
@@ -1278,7 +1279,7 @@ void MythContextPrivate::ShowVersionMismatchPopup(uint remote_version)
     }
 }
 
-void MythContextSlotHandler::ConnectFailurePopupClosed(void)
+void MythContextSlotHandler::ConnectFailurePopupClosed(QObject*)
 {
     d->MBEconnectPopup = NULL;
 }
diff --git a/mythtv/libs/libmyth/mythcontext.h b/mythtv/libs/libmyth/mythcontext.h
index fd9c5c4..c95d901 100644
--- a/mythtv/libs/libmyth/mythcontext.h
+++ b/mythtv/libs/libmyth/mythcontext.h
@@ -21,7 +21,7 @@ class MythContextSlotHandler : public QObject
     MythContextSlotHandler(MythContextPrivate *x) : d(x) { }
 
   private slots:
-    void ConnectFailurePopupClosed(void);
+    void ConnectFailurePopupClosed(QObject*);
     void VersionMismatchPopupClosed(void);
 
   private:
-- 
1.7.9.5

