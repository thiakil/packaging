From 45240ab0fc6c73413e1b6edddc56ba31ee587cae Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Fri, 28 Jan 2011 17:32:22 +0000
Subject: [PATCH 027/285] Enable the detection of a DVD & Bluray discs by
 reading the UDF format data direct from the drive
 using libudf

Signed-off-by: Stuart Morgan <smorgan@mythtv.org>
---
 mythtv/configure                        |   11 +++++++++++
 mythtv/libs/libmyth/libmyth.pro         |    5 +++++
 mythtv/libs/libmyth/mythcdrom-linux.cpp |   29 +++++++++++++++++++++++++++++
 3 files changed, 45 insertions(+)

diff --git a/mythtv/configure b/mythtv/configure
index 3980352..c04349b 100755
--- a/mythtv/configure
+++ b/mythtv/configure
@@ -1308,6 +1308,7 @@ MYTHTV_CONFIG_LIST='
     joystick_menu
     libfftw3
     libmpeg2external
+    libudf
     lirc
     mheg
     opengl_video
@@ -1926,6 +1927,7 @@ enable hdpvr
 enable iptv
 enable ivtv
 enable lamemp3
+enable libudf
 enable lirc
 enable mheg
 enable mythtranscode
@@ -3982,6 +3984,11 @@ fi
 enabled libfftw3 && check_lib2 fftw3.h fftw_init_threads -lfftw3_threads -lfftw3f -lfftw3 ||
     disable libfftw3
 
+enabled libudf && check_cc <<EOF || disable libudf
+#include <cdio/udf.h>
+int main(void){ return UDF_BLOCKSIZE > 0 ? 0 : 1; }
+EOF
+
 enabled x11 && check_lib X11/Xlib.h XQueryExtension -lX11 || disable x11
 enabled xrandr && check_lib X11/extensions/Xrandr.h XRRSelectInput -lXrandr || disable xrandr
 enabled xv && check_lib X11/extensions/Xv.h XvPutStill -lXv || disable xv
@@ -4705,6 +4712,10 @@ if enabled dvb; then
   append CONFIG_INCLUDEPATH "$dvb_path"
 fi
 
+if enabled libudf; then
+  append CCONFIG "using_libudf"
+fi
+
 if enabled x11; then
   if [ -d $x11_path ] ; then
     append CONFIG_INCLUDEPATH "$x11_path"
diff --git a/mythtv/libs/libmyth/libmyth.pro b/mythtv/libs/libmyth/libmyth.pro
index c91a8c0..d39d773 100644
--- a/mythtv/libs/libmyth/libmyth.pro
+++ b/mythtv/libs/libmyth/libmyth.pro
@@ -194,6 +194,11 @@ freebsd {
     HEADERS += mythcdrom-freebsd.h
 }
 
+using_libudf {
+    DEFINES += USING_LIBUDF
+    LIBS += -ludf
+}
+
 INSTALLS += inc inc2
 
 using_alsa {
diff --git a/mythtv/libs/libmyth/mythcdrom-linux.cpp b/mythtv/libs/libmyth/mythcdrom-linux.cpp
index eea65d5..5897a74 100644
--- a/mythtv/libs/libmyth/mythcdrom-linux.cpp
+++ b/mythtv/libs/libmyth/mythcdrom-linux.cpp
@@ -14,6 +14,9 @@
 #include "mythcdrom-linux.h"
 #include "mythconfig.h"      // for HAVE_BIGENDIAN
 #include "mythverbose.h"
+#ifdef USING_LIBUDF
+#include <cdio/udf.h>
+#endif
 
 #define LOC     QString("MythCDROMLinux:")
 #define LOC_ERR QString("MythCDROMLinux, Error: ")
@@ -495,7 +498,33 @@ MediaStatus MythCDROMLinux::checkMedia()
                 }
 
                 VERBOSE(VB_MEDIA, QString("Volume ID: %1").arg(m_VolumeID));
+#ifdef USING_LIBUDF
+                // Check for a DVD/BD disk by reading the UDF root dir.
+                // This allows DVD's to play immediately upon insertion without
+                // calling mount, which either needs pmount or changes to fstab.
+                udf_t *pUdf = udf_open(m_DevicePath.toAscii());
+                if (NULL != pUdf)
+                {
+                    udf_dirent_t *pUdfRoot = udf_get_root(pUdf, true, 0);
+                    if (NULL != pUdfRoot)
+                    {
+                        if (NULL != udf_fopen(pUdfRoot, "VIDEO_TS"))
+                            m_MediaType = MEDIATYPE_DVD;
+                        else if (NULL != udf_fopen(pUdfRoot, "BDMV"))
+                            m_MediaType = MEDIATYPE_BD;
 
+                        udf_dirent_free(pUdfRoot);
+                    }
+                    udf_close(pUdf);
+
+                    if (MEDIATYPE_DATA != m_MediaType)
+                    {
+                        // pretend we're NOTMOUNTED so setStatus emits a signal
+                        m_Status = MEDIASTAT_NOTMOUNTED;
+                        return setStatus(MEDIASTAT_USEABLE, OpenedHere);
+                    }
+                }
+#endif
                 // the base class's onDeviceMounted will do fine
                 // grained detection of the type of data on this disc
                 if (isMounted())
-- 
1.7.9.5

