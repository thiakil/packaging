From 5197a171b4bb1e93c335a76bc13b29bed93f0a38 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Mon, 14 Mar 2011 23:01:03 +0100
Subject: [PATCH 011/285] mytharchive: Compile for Windows

Ticket URL: <http://code.mythtv.org/trac/ticket/9379>

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 .../mytharchive/mytharchive/archiveutil.cpp        |    2 ++
 mythplugins/mytharchive/mytharchive/main.cpp       |    2 ++
 mythplugins/mytharchive/mytharchive/mythburn.cpp   |    2 ++
 mythplugins/mytharchive/mytharchivehelper/main.cpp |   26 +++++++++++++++++---
 .../mytharchive/mytharchivehelper/pxsup2dast.c     |    4 +++
 5 files changed, 32 insertions(+), 4 deletions(-)

diff --git a/mythplugins/mytharchive/mytharchive/archiveutil.cpp b/mythplugins/mytharchive/mytharchive/archiveutil.cpp
index 11d181a..1374d5a 100644
--- a/mythplugins/mytharchive/mytharchive/archiveutil.cpp
+++ b/mythplugins/mytharchive/mytharchive/archiveutil.cpp
@@ -1,5 +1,7 @@
 // POSIX headers
+#ifndef USING_MINGW
 #include <sys/wait.h> // for WIF macros
+#endif
 #include <unistd.h>
 
 // ANSI C headers
diff --git a/mythplugins/mytharchive/mytharchive/main.cpp b/mythplugins/mytharchive/mytharchive/main.cpp
index e777c55..e22df4c 100644
--- a/mythplugins/mytharchive/mytharchive/main.cpp
+++ b/mythplugins/mytharchive/mytharchive/main.cpp
@@ -55,6 +55,7 @@ static bool checkProcess(const QString &lockFile)
         return true;
     }
 
+#ifndef USING_MINGW
     QString line(file.readLine(100));
 
     pid_t pid = line.toInt(&bOK);
@@ -72,6 +73,7 @@ static bool checkProcess(const QString &lockFile)
         if (errno == ESRCH)
             return false;
     }
+#endif
 
     return true;
 }
diff --git a/mythplugins/mytharchive/mytharchive/mythburn.cpp b/mythplugins/mytharchive/mytharchive/mythburn.cpp
index 0c19b45..16e5329 100644
--- a/mythplugins/mytharchive/mytharchive/mythburn.cpp
+++ b/mythplugins/mytharchive/mytharchive/mythburn.cpp
@@ -4,7 +4,9 @@
 #include <unistd.h>
 #include <iostream>
 #include <cstdlib>
+#ifndef USING_MINGW
 #include <sys/wait.h>  // for WIFEXITED and WEXITSTATUS
+#endif
 
 // qt
 #include <QDir>
diff --git a/mythplugins/mytharchive/mytharchivehelper/main.cpp b/mythplugins/mytharchive/mytharchivehelper/main.cpp
index c67795e..90128c5 100644
--- a/mythplugins/mytharchive/mytharchivehelper/main.cpp
+++ b/mythplugins/mytharchive/mytharchivehelper/main.cpp
@@ -26,9 +26,12 @@
 
 #include <iostream>
 #include <stdint.h>
+#ifndef USING_MINGW
 #include <sys/wait.h>  // for WIFEXITED and WEXITSTATUS
+#endif
 #include <unistd.h>
 #include <cstdlib>
+#include <cstring>
 
 #include <mythconfig.h>
 #if CONFIG_DARWIN or defined(__FreeBSD__)
@@ -94,7 +97,11 @@ NativeArchive::NativeArchive(void)
     QString command = QString("echo %1 > " + tempDir +
                       "/logs/mythburn.lck").arg(getpid());
     int res = system(qPrintable(command));
+#ifndef USING_MINGW
     if (WIFEXITED(res) == 0)
+#else
+    if (res == 0)
+#endif
         VERBOSE(VB_IMPORTANT, "NativeArchive: Failed to create lock file");
 }
 
@@ -199,8 +206,10 @@ static bool createISOImage(QString &sourceDirectory)
     command += tempDirectory + "mythburn.iso " + sourceDirectory;
 
     int res = system(qPrintable(command));
+#ifndef USING_MINGW
     if (WIFEXITED(res))
         res = WEXITSTATUS(res);
+#endif
     if (res != 0)
     {
         VERBOSE(VB_JOBQUEUE, QString("ERROR: Failed while running mkisofs. Result: %1")
@@ -257,8 +266,10 @@ static int burnISOImage(int mediaType, bool bEraseDVDRW, bool nativeFormat)
     }
 
     int res = system(qPrintable(command));
+#ifndef USING_MINGW
     if (WIFEXITED(res))
         res = WEXITSTATUS(res);
+#endif
     if (res == 0)
         VERBOSE(VB_JOBQUEUE, "Finished burning ISO image");
     else
@@ -349,7 +360,11 @@ int NativeArchive::doNativeArchive(const QString &jobFile)
         saveDirectory += "work/";
 
         int res = system(qPrintable("rm -fr " + saveDirectory + "*"));
+#ifndef USING_MINGW
         if (!WIFEXITED(res) || WEXITSTATUS(res))
+#else
+        if (res)
+#endif
             VERBOSE(VB_IMPORTANT, "NativeArchive: Failed to clear work directory");
     }
 
@@ -1873,8 +1888,8 @@ static int grabThumbnail(QString inFile, QString thumbList, QString outFile, int
     AVPacket pkt;
     AVPicture orig;
     AVPicture retbuf;
-    bzero(&orig, sizeof(AVPicture));
-    bzero(&retbuf, sizeof(AVPicture));
+    std::memset(&orig, 0, sizeof(AVPicture));
+    std::memset(&retbuf, 0, sizeof(AVPicture));
 
     int bufflen = width * height * 4;
     unsigned char *outputbuf = new unsigned char[bufflen];
@@ -2438,16 +2453,19 @@ static int isRemote(QString filename)
     if (!QFile::exists(filename))
         return 0;
 
+#if CONFIG_DARWIN
     struct statfs statbuf;
-    bzero(&statbuf, sizeof(statbuf));
+    std::memset(&statbuf, 0, sizeof(statbuf));
 
-#if CONFIG_DARWIN
     if ((statfs(qPrintable(filename), &statbuf) == 0) &&
         ((!strcmp(statbuf.f_fstypename, "nfs")) ||      // NFS|FTP
             (!strcmp(statbuf.f_fstypename, "afpfs")) || // ApplShr
             (!strcmp(statbuf.f_fstypename, "smbfs"))))  // SMB
         return 2;
 #elif __linux__
+    struct statfs statbuf;
+    std::memset(&statbuf, 0, sizeof(statbuf));
+
     if ((statfs(qPrintable(filename), &statbuf) == 0) &&
         ((statbuf.f_type == 0x6969) ||      // NFS
             (statbuf.f_type == 0x517B)))    // SMB
diff --git a/mythplugins/mytharchive/mytharchivehelper/pxsup2dast.c b/mythplugins/mytharchive/mytharchivehelper/pxsup2dast.c
index 4b5f542..cc80510 100644
--- a/mythplugins/mytharchive/mytharchivehelper/pxsup2dast.c
+++ b/mythplugins/mytharchive/mytharchivehelper/pxsup2dast.c
@@ -275,7 +275,11 @@ static void xfseek0(FILE * stream, long offset)
 
 static void xmkdir(const char * path, int mode) 
 {
+#ifdef USING_MINGW
+    if (mkdir(path) < 0)
+#else
     if (mkdir(path, mode) < 0)
+#endif
         exc_throw(MiscError, "mkdir(%s, 0%o) failure:", path, mode);
 }
 
-- 
1.7.9.5

