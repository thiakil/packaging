From 34703a7986e86c90ca715c4e4a48d5c957a5f706 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Fri, 2 Aug 2013 12:36:18 +0100
Subject: [PATCH 262/285] MediaMonitor: Retry mount after a 300mS delay if
 initial failure

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmyth/mythmedia.cpp |   47 ++++++++++++++++++++++++-------------
 1 file changed, 31 insertions(+), 16 deletions(-)

diff --git a/mythtv/libs/libmyth/mythmedia.cpp b/mythtv/libs/libmyth/mythmedia.cpp
index 65c475c..9dd167c 100644
--- a/mythtv/libs/libmyth/mythmedia.cpp
+++ b/mythtv/libs/libmyth/mythmedia.cpp
@@ -99,7 +99,7 @@ bool MythMediaDevice::performMountCmd(bool DoMount)
 {
     if (DoMount && isMounted())
     {
-        VERBOSE(VB_MEDIA, "MythMediaDevice::performMountCmd(true)"
+        VERBOSE(VB_MEDIA, LOC + ":performMountCmd(true)"
                           " - Logic Error? Device already mounted.");
         return true;
     }
@@ -121,9 +121,16 @@ bool MythMediaDevice::performMountCmd(bool DoMount)
             MountCommand = QString("%1 %2")
                 .arg((DoMount) ? PATHTO_MOUNT : PATHTO_UNMOUNT)
                 .arg(m_DevicePath);
-    
-        VERBOSE(VB_MEDIA, QString("Executing '%1'").arg(MountCommand));
-        if (0 == myth_system(MountCommand, kMSDontBlockInputDevs))
+
+        VERBOSE(VB_MEDIA, LOC + QString(" Executing '%1'").arg(MountCommand));
+        bool bSuccess = !myth_system(MountCommand, kMSDontBlockInputDevs);
+        if (!bSuccess)
+        {
+            usleep(300000);
+            VERBOSE(VB_MEDIA, LOC + QString(" Retrying '%1'").arg(MountCommand));
+            bSuccess = !myth_system(MountCommand, kMSDontBlockInputDevs);
+        }
+        if (bSuccess)
         {
             if (DoMount)
             {
@@ -133,16 +140,23 @@ bool MythMediaDevice::performMountCmd(bool DoMount)
                 // in /etc/fstab then pmount delegates to mount which
                 // performs the mount asynchronously so we must wait a bit
                 usleep(1000000);
+                for (int tries = 2; !findMountPath() && tries > 0; --tries)
+                {
+                    VERBOSE(VB_MEDIA, LOC +
+                            QString(" Repeating '%1'").arg(MountCommand));
+                    myth_system(MountCommand, kMSDontBlockInputDevs);
+                    usleep(500000);
+                }
                 if (!findMountPath())
                 {
-                    VERBOSE(VB_MEDIA, "performMountCmd() attempted to"
+                    VERBOSE(VB_MEDIA, LOC + ":performMountCmd() attempted to"
                                       " find mounted media, but failed?");
                     return false;
                 }
                 m_Status = MEDIASTAT_MOUNTED;
                 onDeviceMounted();
-                VERBOSE(VB_GENERAL,
-                        QString("Detected MediaType ") + MediaTypeString());
+                VERBOSE(VB_GENERAL, LOC +
+                     " Detected MediaType " + MediaTypeString());
             }
             else
                 onDeviceUnmounted();
@@ -150,8 +164,8 @@ bool MythMediaDevice::performMountCmd(bool DoMount)
             return true;
         }
         else
-            VERBOSE(VB_GENERAL, QString("Failed to mount %1.")
-                                       .arg(m_DevicePath));
+            VERBOSE(VB_GENERAL, QString("Failed to %1 %2.")
+                .arg(DoMount ? "mount" : "unmount").arg(m_DevicePath));
     } 
     else 
     {
@@ -392,23 +406,24 @@ bool MythMediaDevice::findMountPath()
             return true;
         }
 
-        if (VERBOSE_LEVEL_CHECK(VB_MEDIA))
+        if (VERBOSE_LEVEL_CHECK(VB_MEDIA|VB_EXTRA))
             debug += QString("                 %1 | %2\n")
                      .arg(deviceName, 16).arg(mountPoint);
     }
 
     mountFile.close();
 
-    if (VERBOSE_LEVEL_CHECK(VB_MEDIA))
+    if (VERBOSE_LEVEL_CHECK(VB_MEDIA|VB_EXTRA))
     {
-        debug = LOC + ":findMountPath() - mount of '"
-                + m_DevicePath + "' not found.\n"
-                + "                 Device name/type | Current mountpoint\n"
-                + "                 -----------------+-------------------\n"
+        debug =   "\n"
+                  "                 Device name/type | Current mountpoint\n"
+                  "                 -----------------+-------------------\n"
                 + debug
                 + "                 =================+===================";
-        VERBOSE(VB_MEDIA, debug);
     }
+    VERBOSE(VB_MEDIA, LOC +
+            QString(":findMountPath() - '%1' not found.")
+                .arg(m_DevicePath) + debug);
 
     return false;
 }
-- 
1.7.9.5

