From 3654c0f315bbaf6ef6c1e7ffe2d4d1cf030d4d5c Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Fri, 12 Jul 2013 15:13:07 +0100
Subject: [PATCH 256/285] Player: Finer a/v sync adjustments

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythtv/mythplayer.cpp |   15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/mythtv/libs/libmythtv/mythplayer.cpp b/mythtv/libs/libmythtv/mythplayer.cpp
index 8baceb0..54f1426 100644
--- a/mythtv/libs/libmythtv/mythplayer.cpp
+++ b/mythtv/libs/libmythtv/mythplayer.cpp
@@ -1799,7 +1799,7 @@ void MythPlayer::AVSync(VideoFrame *buffer, bool limit_delay)
             avsync_holdoff = 1;
         else if (abs(timecode - prevtc) > maxdiff)
         {
-            VERBOSE(VB_PLAYBACK, QString(
+            VERBOSE(VB_PLAYBACK, LOC + QString(
                     "Discontinuous video timecodes %1 -> %2")
                 .arg(prevtc)
                 .arg(timecode)
@@ -1808,7 +1808,7 @@ void MythPlayer::AVSync(VideoFrame *buffer, bool limit_delay)
         }
         else if (abs(currentaudiotime - prev_audiotime) > maxdiff)
         {
-            VERBOSE(VB_PLAYBACK, QString(
+            VERBOSE(VB_PLAYBACK, LOC + QString(
                     "Discontinuous audio timecodes %1 -> %2")
                 .arg(prev_audiotime)
                 .arg(currentaudiotime)
@@ -1819,7 +1819,7 @@ void MythPlayer::AVSync(VideoFrame *buffer, bool limit_delay)
         }
         else if (abs(timecode - currentaudiotime) > 4000)
         {
-            VERBOSE(VB_PLAYBACK, QString(
+            VERBOSE(VB_PLAYBACK, LOC + QString(
                     "Excessive A/V timecode difference: audio %1 video %2")
                 .arg(currentaudiotime)
                 .arg(timecode)
@@ -1841,6 +1841,7 @@ void MythPlayer::AVSync(VideoFrame *buffer, bool limit_delay)
                 prevrp == 0)
             {
                 // wait an extra frame interval
+                VERBOSE(VB_PLAYBACK, LOC + "Dropped frame, wait a frame interval");
                 avsync_adjustment += frame_interval;
             }
             prevrp = repeat_pict;
@@ -1855,13 +1856,17 @@ void MythPlayer::AVSync(VideoFrame *buffer, bool limit_delay)
                the video by one interlaced field (1/2 frame) */
             if (!lastsync)
             {
-                if (avsync_avg > frame_interval * 3 / 2)
+                if (avsync_avg >= (4 * refreshrate) / 3)
                 {
+                    VERBOSE(VB_PLAYBACK|VB_EXTRA, LOC +
+                        "Video leads audio - wait a sync interval");
                     avsync_adjustment += refreshrate;
                     lastsync = true;
                 }
-                else if (avsync_avg < 0 - frame_interval * 3 / 2)
+                else if (avsync_avg <= -(4 * refreshrate) / 3)
                 {
+                    VERBOSE(VB_PLAYBACK|VB_EXTRA, LOC +
+                        "Video lags audio - advance a sync interval");
                     avsync_adjustment -= refreshrate;
                     lastsync = true;
                 }
-- 
1.7.9.5

