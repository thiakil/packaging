From 4d1223de343afeb4aeb7af8ad65c6b9dbb104b3e Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sat, 29 Jun 2013 18:30:31 +0100
Subject: [PATCH 242/285] MHEG: allow escape key to exit liveTV in input
 register 5

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythtv/mhi.cpp |   18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/mythtv/libs/libmythtv/mhi.cpp b/mythtv/libs/libmythtv/mhi.cpp
index e456cd6..724fcde 100644
--- a/mythtv/libs/libmythtv/mhi.cpp
+++ b/mythtv/libs/libmythtv/mhi.cpp
@@ -15,6 +15,7 @@
 #include "mythdirs.h"
 #include "mythverbose.h"
 #include "myth_imgconvert.h"
+#include "mythmainwindow.h"
 
 static bool       ft_loaded = false;
 static FT_Library ft_library;
@@ -524,7 +525,8 @@ private:
 void MHKeyLookup::key(const QString &name, int code, int r1,
     int r2, int r3, int r4, int r5, int r6, int r7, int r8, int r9)
 {
-    m_map.insert(key_t(name,r1), code);
+    if (r1 > 0)
+      m_map.insert(key_t(name,r1), code);
     if (r2 > 0)
         m_map.insert(key_t(name,r2), code);
     if (r3 > 0)
@@ -545,6 +547,13 @@ void MHKeyLookup::key(const QString &name, int code, int r1,
 
 MHKeyLookup::MHKeyLookup()
 {
+    // Use a modification of the standard key mapping for RC's with a single
+    // stop button which is used for both Esc and TEXTEXIT (Back).
+    // This mapping doesn't pass Esc to the MHEG app in registers 3 or 5 and
+    // hence allows the user to exit playback when the red button icon is shown
+    QStringList keylist = GET_KEY("TV Playback", "TEXTEXIT").split(QChar(','));
+    bool strict = !keylist.contains("Esc", Qt::CaseInsensitive);
+
     // This supports the UK and NZ key profile registers.
     // The UK uses 3, 4 and 5 and NZ 13, 14 and 15.  These are
     // similar but the NZ profile also provides an EPG key.
@@ -565,7 +574,7 @@ MHKeyLookup::MHKeyLookup()
     key("8",           13, 4,6,7,14);
     key("9",           14, 4,6,7,14);
     key("SELECT",      15, 4,5,6,7,14,15);
-    key("TEXTEXIT",    16, 3,4,5,6,7,13,14,15); // 16= Cancel
+    key("TEXTEXIT",    16, strict ? 3 : 0,4,strict ? 5 : 0,6,7,13,14,15); // 16= Cancel
     // 17= help
     // 18..99 reserved by DAVIC
     key("MENURED",    100, 3,4,5,6,7,13,14,15);
@@ -609,10 +618,7 @@ bool MHIContext::OfferKey(QString key)
     { QMutexLocker locker(&m_keyLock);
     m_keyQueue.enqueue(action);}
     m_engine_wait.wakeAll();
-    // Accept the key except 'exit' (16) in 'always available' (3) state.
-    // This allows re-use of Esc as TEXTEXIT for RC's with a single backup button
-    // But if the MHEG app is hung the user can press esc twice to exit TV
-    return action != 16 || (m_keyProfile != 3 && m_keyQueue.size() < 2);
+    return true;
 }
 
 // Called from MythPlayer::VideoStart and MythPlayer::ReinitOSD
-- 
1.7.9.5

