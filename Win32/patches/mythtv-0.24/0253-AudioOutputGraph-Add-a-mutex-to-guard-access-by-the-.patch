From 62fe772bbb528b5c575812619efe69bb37f38377 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sun, 7 Jul 2013 20:10:28 +0100
Subject: [PATCH 253/285] AudioOutputGraph: Add a mutex to guard access by the
 decoder and UI threads

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmyth/audiooutputgraph.cpp |    7 +++++++
 mythtv/libs/libmyth/audiooutputgraph.h   |    3 +++
 2 files changed, 10 insertions(+)

diff --git a/mythtv/libs/libmyth/audiooutputgraph.cpp b/mythtv/libs/libmyth/audiooutputgraph.cpp
index cfc7af5..7fc04bd 100644
--- a/mythtv/libs/libmyth/audiooutputgraph.cpp
+++ b/mythtv/libs/libmyth/audiooutputgraph.cpp
@@ -6,6 +6,7 @@
 #include <QImage>
 #include <QByteArray>
 #include <QPair>
+#include <QMutexLocker>
 
 #include "mythverbose.h"
 #include "mythpainter.h"
@@ -181,6 +182,7 @@ AudioOutputGraph::~AudioOutputGraph()
 
 void AudioOutputGraph::SetPainter(MythPainter* painter)
 {
+    QMutexLocker lock(&m_mutex);
     m_painter = painter;
 }
 
@@ -188,6 +190,7 @@ void AudioOutputGraph::SetSampleRate(unsigned sample_rate)
 {
     VERBOSE(VB_PLAYBACK, LOC + QString("(%1)").arg(sample_rate));
 
+    QMutexLocker lock(&m_mutex);
     m_buffer->SetSampleRate(sample_rate);
 }
 
@@ -195,6 +198,7 @@ void AudioOutputGraph::SetSampleCount(unsigned sample_count)
 {
     VERBOSE(VB_PLAYBACK, LOC + QString("(%1)").arg(sample_count));
 
+    QMutexLocker lock(&m_mutex);
     m_buffer->SetMaxSamples(sample_count);
 }
 
@@ -204,6 +208,7 @@ void AudioOutputGraph::prepare()
 
 void AudioOutputGraph::add(uchar *buf, unsigned long len, unsigned long timecode, int channels, int bits)
 {
+    QMutexLocker lock(&m_mutex);
     m_buffer->Append(buf, len, timecode, channels, bits);
 }
 
@@ -211,6 +216,7 @@ void AudioOutputGraph::Reset()
 {
     VERBOSE(VB_PLAYBACK, LOC);
 
+    QMutexLocker lock(&m_mutex);
     m_buffer->Empty();
 }
 
@@ -258,6 +264,7 @@ template <typename T> QImage Draw(int width, const T *p,
 
 MythImage *AudioOutputGraph::GetImage(int64_t timecode) const
 {
+    QMutexLocker lock(&m_mutex);
     Buffer::range_t avail = m_buffer->Avail(timecode);
 
     VERBOSE(VB_PLAYBACK, LOC +
diff --git a/mythtv/libs/libmyth/audiooutputgraph.h b/mythtv/libs/libmyth/audiooutputgraph.h
index 8a823f4..b4a328f 100644
--- a/mythtv/libs/libmyth/audiooutputgraph.h
+++ b/mythtv/libs/libmyth/audiooutputgraph.h
@@ -2,6 +2,8 @@
 #define AUDIOOUTPUTGRAPH_H
 #include <stdint.h>
 
+#include <QMutex>
+
 #include "visual.h"
 
 class MythImage;
@@ -38,6 +40,7 @@ private:
     int m_dBsilence, m_dBquiet, m_dBLoud, m_dbMax;
     class Buffer;
     Buffer * const m_buffer;
+    QMutex mutable m_mutex;
 };
 
 #endif // AUDIOOUTPUTGRAPH_H
-- 
1.7.9.5

