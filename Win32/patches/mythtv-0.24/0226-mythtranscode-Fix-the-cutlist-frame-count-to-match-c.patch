From 2e0f6d8fa4c51eb4a0cf9232d4b75db4904e3d34 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Wed, 19 Jun 2013 18:31:22 +0100
Subject: [PATCH 226/285] mythtranscode: Fix the cutlist frame count to match
 commflag and the cutlist editor

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/programs/mythtranscode/mpeg2fix.cpp |   13 +++++++++++++
 mythtv/programs/mythtranscode/mpeg2fix.h   |    1 +
 2 files changed, 14 insertions(+)

diff --git a/mythtv/programs/mythtranscode/mpeg2fix.cpp b/mythtv/programs/mythtranscode/mpeg2fix.cpp
index 5980c2e..f3301e6 100644
--- a/mythtv/programs/mythtranscode/mpeg2fix.cpp
+++ b/mythtv/programs/mythtranscode/mpeg2fix.cpp
@@ -246,6 +246,7 @@ MPEG2fixup::MPEG2fixup(const QString &inf, const QString &outf,
     mpeg2_malloc_hooks(my_malloc, NULL);
     header_decoder = mpeg2_init();
     img_decoder = mpeg2_init();
+    droppedFrames = 0;
 
     av_register_all();
     av_log_set_callback(my_av_print);
@@ -1360,6 +1361,7 @@ int MPEG2fixup::GetFrame(AVPacket *pkt)
                     return 0;
                 framePool.enqueue(vFrame.last());
                 vFrame.removeLast();
+                ++droppedFrames;
 
                 break;
 
@@ -1987,6 +1989,10 @@ int MPEG2fixup::Start()
 
     InitReplex();
 
+    // Include initial partial video frames to match Mythcommflag & the cutlist editor
+    frame_count = droppedFrames;
+    VERBOSE(MPF_PROCESS, QString("Initial frame count: %1").arg(frame_count) );
+
     while (1)
     {
         /* read packet */
@@ -2127,6 +2133,13 @@ int MPEG2fixup::Start()
                         delMap.remove(delMap.begin());
                         markedFrameP = curFrame;
 
+                        VERBOSE(MPF_PROCESS, QString("Cut %1 at frame %2, PTS %3 (+%4)")
+                            .arg(new_discard_state ? "begins" : "ends")
+                            .arg(frame_count)
+                            .arg(PtsTime(markedFrameP->pkt.pts))
+                            .arg(PtsTime(markedFrameP->pkt.pts - initPTS))
+                        );
+
                         if (!new_discard_state)
                         {
                             cutEndPTS = markedFrameP->pkt.pts;
diff --git a/mythtv/programs/mythtranscode/mpeg2fix.h b/mythtv/programs/mythtranscode/mpeg2fix.h
index e1d089f..5d8dfec 100644
--- a/mythtv/programs/mythtranscode/mpeg2fix.h
+++ b/mythtv/programs/mythtranscode/mpeg2fix.h
@@ -270,6 +270,7 @@ class MPEG2fixup
     int framenum;
     int status_update_time;
     uint64_t last_written_pos;
+    int droppedFrames;
 };
 
 #ifdef NO_MYTH
-- 
1.7.9.5

