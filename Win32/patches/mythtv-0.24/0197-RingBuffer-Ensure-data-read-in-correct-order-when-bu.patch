From 87e7eaf051ce075e5c4cc4bb424bc55bb744dbac Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Wed, 12 Jun 2013 14:52:24 +0100
Subject: [PATCH 197/285] RingBuffer: Ensure data read in correct order when
 buffer paused

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythtv/RingBuffer.cpp |   13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/mythtv/libs/libmythtv/RingBuffer.cpp b/mythtv/libs/libmythtv/RingBuffer.cpp
index 3e7268b..7e05d0f 100644
--- a/mythtv/libs/libmythtv/RingBuffer.cpp
+++ b/mythtv/libs/libmythtv/RingBuffer.cpp
@@ -1150,6 +1150,7 @@ void RingBuffer::StartReads(void)
  */
 void RingBuffer::Pause(void)
 {
+    VERBOSE(VB_FILE, LOC + "Pause");
     StopReads();
 
     rwlock.lockForWrite();
@@ -1163,6 +1164,7 @@ void RingBuffer::Pause(void)
  */
 void RingBuffer::Unpause(void)
 {
+    VERBOSE(VB_FILE, LOC + "Unpause");
     StartReads();
 
     rwlock.lockForWrite();
@@ -1633,10 +1635,9 @@ bool RingBuffer::WaitForAvail(int count)
 
     MythTimer t; t.start();
     wanttoread = count;
-    while (avail < count && !stopreads && !request_pause &&
-            !commserror && readaheadrunning)
+    while (avail < count && !commserror && readaheadrunning)
     {
-        if (ateof)
+        if (ateof || stopreads || request_pause)
         {
             count = avail;
             break;
@@ -1801,7 +1802,7 @@ int RingBuffer::ReadPriv(void *buf, int count, bool peek)
         return -1;
     }
 
-    if (request_pause || stopreads || !readaheadrunning || (ignorereadpos>=0))
+    if (!readaheadrunning || (ignorereadpos>=0) || stopreads || request_pause)
     {
         rwlock.unlock();
         rwlock.lockForWrite();
@@ -1810,8 +1811,8 @@ int RingBuffer::ReadPriv(void *buf, int count, bool peek)
         // If the read ahead thread was started while we
         // didn't hold the lock, we proceed with a normal
         // read from the buffer, otherwise we read directly.
-        if (request_pause || stopreads ||
-            !readaheadrunning || (ignorereadpos >= 0))
+        if (!readaheadrunning || (ignorereadpos >= 0) ||
+            ((stopreads || request_pause) && !ReadBufAvail()) )
         {
             VERBOSE(VB_FILE, LOC + loc_desc + " -- direct read");
             int ret = ReadDirect(buf, count, peek);
-- 
1.7.9.5

