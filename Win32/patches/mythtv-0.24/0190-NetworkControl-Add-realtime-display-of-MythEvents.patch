From db4203a053671dd6b74ae862e80f0c23bf8f54c1 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Fri, 17 May 2013 11:59:30 +0100
Subject: [PATCH 190/285] NetworkControl: Add realtime display of MythEvents

This patch displays all MythEvents to NetworkControl clients.

Syntax:
set events on|off|0|1
query events -> On|Off

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/programs/mythfrontend/networkcontrol.cpp |   45 ++++++++++++++++++++++-
 mythtv/programs/mythfrontend/networkcontrol.h   |    4 ++
 2 files changed, 47 insertions(+), 2 deletions(-)

diff --git a/mythtv/programs/mythfrontend/networkcontrol.cpp b/mythtv/programs/mythfrontend/networkcontrol.cpp
index d007603..df7dd35 100644
--- a/mythtv/programs/mythfrontend/networkcontrol.cpp
+++ b/mythtv/programs/mythfrontend/networkcontrol.cpp
@@ -294,10 +294,11 @@ void NetworkControl::RunCommandThread(void)
 
 void NetworkControl::processNetworkControlCommand(NetworkCommand *nc)
 {
-    QMutexLocker locker(&clientLock);
     QString result;
 
+    clientLock.lock();
     int clientID = clients.indexOf(nc->getClient());
+    clientLock.unlock();
 
     if (is_abbrev("jump", nc->getArg(0)))
         result = processJump(nc);
@@ -392,7 +393,7 @@ void NetworkControl::newConnection()
     notifyDataAvailable();
 }
 
-NetworkControlClient::NetworkControlClient(QTcpSocket *s)
+NetworkControlClient::NetworkControlClient(QTcpSocket *s) : m_bEvents(false)
 {
     m_socket = s;
     m_textStream = new QTextStream(s);
@@ -912,6 +913,10 @@ QString NetworkControl::processQuery(NetworkCommand *nc)
             return QString("ERROR: See 'help %1' for usage information "
                            "(parameters mismatch)").arg(nc->getArg(0));
     }
+    else if (is_abbrev("events", nc->getArg(1)))
+    {
+        result = nc->getClient()->WantsEvents() ? "On" : "Off";
+    }
     else
         return QString("ERROR: See 'help %1' for usage information")
                        .arg(nc->getArg(0));
@@ -953,6 +958,21 @@ QString NetworkControl::processSet(NetworkCommand *nc)
 
         return result;
     }
+    else if (is_abbrev("events", nc->getArg(1)))
+    {
+        QString res = "OK";
+
+        if (nc->getArgCount() < 3)
+            res = "ERROR: Missing event value.";
+        else if (nc->getArg(2) == "0" || nc->getArg(2).toLower() == "off")
+            nc->getClient()->WantsEvents(false);
+        else if (nc->getArg(2) == "1" || nc->getArg(2).toLower() == "on")
+            nc->getClient()->WantsEvents(true);
+        else
+            res = "ERROR: Invalid event value.";
+
+        return res;
+    }
 
     return QString("ERROR: See 'help %1' for usage information")
                    .arg(nc->getArg(0));
@@ -1141,6 +1161,27 @@ void NetworkControl::customEvent(QEvent *e)
     {
         MythEvent *me = (MythEvent *)e;
         QString message = me->Message();
+        QString data = (me->ExtraDataCount() > 0 && me->ExtraData(0) != "empty") ?
+            " [" + me->ExtraDataList().join("][") + "]" : QString();
+
+        bool notify = false;
+        clientLock.lock();
+        for ( QList<NetworkControlClient*>::const_iterator it = clients.begin();
+            it != clients.end(); ++it)
+        {
+            NetworkControlClient* ncc = *it;
+            if (ncc->WantsEvents())
+            {
+                nrLock.lock();
+                networkControlReplies.push_back(new NetworkCommand(ncc, message + data));
+                nrLock.unlock();
+                notify = true;
+            }
+        }
+        clientLock.unlock();
+
+        if (notify)
+            notifyDataAvailable();
 
         if (message.left(15) != "NETWORK_CONTROL")
             return;
diff --git a/mythtv/programs/mythfrontend/networkcontrol.h b/mythtv/programs/mythfrontend/networkcontrol.h
index 8ed9c64..29aafec 100644
--- a/mythtv/programs/mythfrontend/networkcontrol.h
+++ b/mythtv/programs/mythfrontend/networkcontrol.h
@@ -30,6 +30,9 @@ class NetworkControlClient : public QObject
     QTcpSocket  *getSocket()     { return m_socket; }
     QTextStream *getTextStream() { return m_textStream; }
 
+    bool WantsEvents() const { return m_bEvents; }
+    void WantsEvents(bool b) { m_bEvents = b; }
+
   signals:
     void commandReceived(QString&);
 
@@ -39,6 +42,7 @@ class NetworkControlClient : public QObject
   private:
     QTcpSocket  *m_socket;
     QTextStream *m_textStream;
+    bool m_bEvents;
 };
 
 class NetworkCommand : public QObject
-- 
1.7.9.5

