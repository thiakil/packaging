From ba79dfd7816f9b01b37b01ec103858c06fce00fb Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Wed, 12 Jun 2013 16:12:14 +0100
Subject: [PATCH 045/202] Player: Fix IsNearEnd so speed changes to x1 near
 end of recording

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythtv/mythplayer.cpp |   26 ++++++++++----------------
 1 file changed, 10 insertions(+), 16 deletions(-)

diff --git a/mythtv/libs/libmythtv/mythplayer.cpp b/mythtv/libs/libmythtv/mythplayer.cpp
index 4c6fbe3..b36b684 100644
--- a/mythtv/libs/libmythtv/mythplayer.cpp
+++ b/mythtv/libs/libmythtv/mythplayer.cpp
@@ -3791,8 +3791,6 @@ bool MythPlayer::IsReallyNearEnd(void) const
  */
 bool MythPlayer::IsNearEnd(void)
 {
-    uint64_t framesRead, framesLeft = 0;
-
     if (!player_ctx)
         return false;
 
@@ -3805,11 +3803,11 @@ bool MythPlayer::IsNearEnd(void)
     }
     player_ctx->UnlockPlayingInfo(__FILE__, __LINE__);
 
-    long long margin = (long long)(video_frame_rate * 2);
-    margin = (long long) (margin * audio.GetStretchFactor());
+    uint64_t margin = (uint64_t)(video_frame_rate * 2);
+    margin = (uint64_t) (margin * audio.GetStretchFactor());
     bool watchingTV = IsWatchingInprogress();
 
-    framesRead = framesPlayed;
+    uint64_t framesRead = framesPlayed;
 
     if (!player_ctx->IsPIP() &&
         player_ctx->GetState() == kState_WatchingPreRecorded)
@@ -3817,8 +3815,7 @@ bool MythPlayer::IsNearEnd(void)
         if (framesRead >= deleteMap.GetLastFrame())
             return true;
         uint64_t frameCount = GetCurrentFrameCount();
-        framesLeft = (frameCount > framesRead) ? frameCount - framesRead : 0;
-        return (framesLeft < (uint64_t)margin);
+        return frameCount < framesRead + margin;
     }
 
     if (!livetv && !watchingTV)
@@ -3827,17 +3824,14 @@ bool MythPlayer::IsNearEnd(void)
     if (livetv && player_ctx->tvchain && player_ctx->tvchain->HasNext())
         return false;
 
-    if (player_ctx->recorder)
-    {
-        framesLeft =
-            player_ctx->recorder->GetCachedFramesWritten() - framesRead;
+    if (!player_ctx->recorder)
+        return false;
 
-        // if it looks like we are near end, get an updated GetFramesWritten()
-        if (framesLeft < (uint64_t)margin)
-            framesLeft = player_ctx->recorder->GetFramesWritten() - framesRead;
-    }
+    uint64_t framesWritten = (uint64_t)player_ctx->recorder->GetCachedFramesWritten();
+    if (framesWritten < framesRead + margin)
+        framesWritten = player_ctx->recorder->GetFramesWritten();
 
-    return (framesLeft < (uint64_t)margin);
+    return framesWritten < framesRead + margin;
 }
 
 bool MythPlayer::DoFastForward(uint64_t frames, double inaccuracy)
-- 
1.7.9.5

