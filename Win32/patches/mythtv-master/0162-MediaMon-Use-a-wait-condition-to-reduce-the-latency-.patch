From a3d36a6f70578248bdfdf0f613c29d4b4afebeff Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sun, 11 Aug 2013 19:58:37 +0100
Subject: [PATCH 162/202] MediaMon: Use a wait condition to reduce the latency
 exiting mythfrontend

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmyth/mythmediamonitor.cpp |    6 +++++-
 mythtv/libs/libmyth/mythmediamonitor.h   |    4 +++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/mythtv/libs/libmyth/mythmediamonitor.cpp b/mythtv/libs/libmyth/mythmediamonitor.cpp
index d9ee655..7235bd8 100644
--- a/mythtv/libs/libmyth/mythmediamonitor.cpp
+++ b/mythtv/libs/libmyth/mythmediamonitor.cpp
@@ -51,10 +51,12 @@ MonitorThread::MonitorThread(MediaMonitor* pMon, unsigned long interval) :
 void MonitorThread::run(void)
 {
     RunProlog();
+    QMutex mtx;
+    mtx.lock();
     while (m_Monitor && m_Monitor->IsActive())
     {
         m_Monitor->CheckDevices();
-        msleep(m_Interval);
+        m_Monitor->m_wait.wait(&mtx, m_Interval);
     }
     RunEpilog();
 }
@@ -439,7 +441,9 @@ void MediaMonitor::StopMonitoring(void)
 
     LOG(VB_MEDIA, LOG_NOTICE, "Stopping MediaMonitor");
     m_Active = false;
+    m_wait.wakeAll();
     m_Thread->wait();
+    LOG(VB_MEDIA, LOG_NOTICE, "Stopped MediaMonitor");
 }
 
 /** \fn MediaMonitor::ValidateAndLock(MythMediaDevice *pMedia)
diff --git a/mythtv/libs/libmyth/mythmediamonitor.h b/mythtv/libs/libmyth/mythmediamonitor.h
index 04b0680..b87e233 100644
--- a/mythtv/libs/libmyth/mythmediamonitor.h
+++ b/mythtv/libs/libmyth/mythmediamonitor.h
@@ -4,6 +4,7 @@
 #include <QStringList>
 #include <QPointer>
 #include <QMutex>
+#include <QWaitCondition>
 #include <QList>
 
 #include "mthread.h"
@@ -115,7 +116,8 @@ class MPUBLIC MediaMonitor : public QObject
     // List of devices/mountpoints that the user doesn't want to monitor:
     QStringList                  m_IgnoreList;
 
-    bool                         m_Active;      ///< Was MonitorThread started?
+    bool volatile                m_Active;      ///< Was MonitorThread started?
+    QWaitCondition               m_wait;
     MonitorThread                *m_Thread;
     unsigned long                m_MonitorPollingInterval;
     bool                         m_AllowEject;
-- 
1.7.9.5

