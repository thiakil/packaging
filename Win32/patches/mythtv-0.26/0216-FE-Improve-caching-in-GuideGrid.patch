From fdbf81e78a93651536906e927a9cbc24b8adab1a Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Thu, 22 Aug 2013 16:20:35 +0100
Subject: [PATCH 216/227] FE: Improve caching in GuideGrid

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/programs/mythfrontend/guidegrid.cpp |   68 +++++++++++++++++++++-------
 mythtv/programs/mythfrontend/guidegrid.h   |    1 +
 2 files changed, 53 insertions(+), 16 deletions(-)

diff --git a/mythtv/programs/mythfrontend/guidegrid.cpp b/mythtv/programs/mythfrontend/guidegrid.cpp
index bac5e18..1c053e1 100644
--- a/mythtv/programs/mythfrontend/guidegrid.cpp
+++ b/mythtv/programs/mythfrontend/guidegrid.cpp
@@ -12,6 +12,8 @@ using namespace std;
 #include <QCoreApplication>
 #include <QKeyEvent>
 #include <QDateTime>
+#include <QList>
+#include <QMap>
 
 // myth
 #include "mythcorecontext.h"
@@ -41,6 +43,11 @@ QWaitCondition epgIsVisibleCond;
 const QString kUnknownTitle = QObject::tr("Unknown");
 const QString kUnknownCategory = QObject::tr("Unknown");
 
+// ProgramList cache for getProgramListFromProgram
+typedef QList< ProgramInfo >  SafeProgramList;
+typedef QMap< int, SafeProgramList > PrgLstCache_t;
+static PrgLstCache_t s_prgLstCache;
+
 JumpToChannel::JumpToChannel(
     JumpToChannelListener *parent, const QString &start_entry,
     int start_chan_idx, int cur_chan_idx, uint rows_disp) :
@@ -258,6 +265,7 @@ GuideGrid::GuideGrid(MythScreenStack *parent,
     int secsoffset = -((m_originalStartTime.time().minute() % 30) * 60 +
                         m_originalStartTime.time().second());
     m_currentStartTime = m_originalStartTime.addSecs(secsoffset);
+    s_prgLstCache.clear();
     m_startChanID  = chanid;
     m_startChanNum = channum;
 }
@@ -302,6 +310,7 @@ bool GuideGrid::Create()
     m_verticalLayout = m_guideGrid->isVerticalLayout();
 
     m_currentEndTime = m_currentStartTime.addSecs(m_timeCount * 60 * 5);
+    s_prgLstCache.clear();
 
     LoadInBackground();
     return true;
@@ -310,6 +319,7 @@ bool GuideGrid::Create()
 void GuideGrid::Load(void)
 {
     LoadFromScheduler(m_recList);
+    s_prgLstCache.clear();
     fillChannelInfos();
 
     int maxchannel = max((int)GetChannelCount() - 1, 0);
@@ -851,6 +861,7 @@ void GuideGrid::updateTimeout(void)
 {
     m_updateTimer->stop();
     fillProgramInfos();
+    updateChannels();
     m_updateTimer->start((int)(60 * 1000));
 }
 
@@ -1054,11 +1065,14 @@ void GuideGrid::fillTimeInfos()
         starttime = starttime.addSecs(5 * 60);
     }
     m_currentEndTime = starttime;
+    s_prgLstCache.clear();
 }
 
 void GuideGrid::fillProgramInfos(bool useExistingData)
 {
     m_guideGrid->ResetData();
+    if (!useExistingData)
+        s_prgLstCache.clear();
 
     for (int y = 0; y < m_channelCount; ++y)
     {
@@ -1072,6 +1086,18 @@ ProgramList *GuideGrid::getProgramListFromProgram(int chanNum)
 
     if (proglist)
     {
+        PrgLstCache_t::const_iterator it = s_prgLstCache.find(chanNum);
+        if (it != s_prgLstCache.end())
+        {
+            const SafeProgramList &plist = it.value();
+            for ( SafeProgramList::const_iterator it2 = plist.begin();
+                it2 != plist.end(); ++it2)
+            {
+                proglist->push_back( new ProgramInfo(*it2));
+            }
+            return proglist;
+        }
+
         MSqlBindings bindings;
         QString querystr = "WHERE program.chanid = :CHANID "
                            "  AND program.endtime >= :STARTTS "
@@ -1084,6 +1110,15 @@ ProgramList *GuideGrid::getProgramListFromProgram(int chanNum)
             m_currentEndTime.addSecs(0 - m_currentEndTime.time().second());
 
         LoadFromProgram(*proglist, querystr, bindings, m_recList);
+
+        // Make a deep copy for the cache
+        SafeProgramList list;
+        for ( ProgramList::const_iterator it2 = proglist->begin();
+            it2 != proglist->end(); ++it2)
+        {
+            list.append(**it2);
+        }
+        s_prgLstCache.insert(chanNum, list);
     }
 
     return proglist;
@@ -1511,9 +1546,6 @@ void GuideGrid::updateChannels(void)
 
     DBChannel *chinfo = GetChannelInfo(m_currentStartChannel);
 
-    if (m_player)
-        m_player->ClearTunableCache();
-
     for (unsigned int y = 0; (y < (unsigned int)m_channelCount) && chinfo; ++y)
     {
         unsigned int chanNumber = y + m_currentStartChannel;
@@ -1526,11 +1558,19 @@ void GuideGrid::updateChannels(void)
 
         bool unavailable = false, try_alt = false;
 
-        if (m_player)
+        if (m_player && chinfo)
         {
+            const int kMaxCacheAge = 5 * 1000; //millisecs
+            if (!m_tuneableCacheAge.isValid() ||
+                 m_tuneableCacheAge.elapsed() > kMaxCacheAge)
+            {
+                m_player->ClearTunableCache();
+                m_tuneableCacheAge.start();
+            }
+
             const PlayerContext *ctx = m_player->GetPlayerReadLock(
                 -1, __FILE__, __LINE__);
-            if (ctx && chinfo)
+            if (ctx)
                 try_alt = !m_player->IsTunable(ctx, chinfo->chanid, true);
             m_player->ReturnPlayerLock(ctx);
         }
@@ -1802,7 +1842,7 @@ void GuideGrid::cursorRight()
 
     m_currentCol = startCol + spread;
 
-    if (m_currentCol > m_timeCount - 1)
+    if (m_currentCol >= m_timeCount)
     {
         m_currentCol = m_timeCount - 1;
         moveLeftRight(kScrollRight);
@@ -1817,37 +1857,33 @@ void GuideGrid::cursorRight()
 
 void GuideGrid::cursorDown()
 {
-    m_currentRow++;
-
-    if (m_currentRow > m_channelCount - 1)
+    if (++m_currentRow >= m_channelCount)
     {
         m_currentRow = m_channelCount - 1;
         moveUpDown(kScrollDown);
     }
     else
     {
-        fillProgramRowInfos(m_currentRow);
+        fillProgramRowInfos(m_currentRow, true);
         m_guideGrid->SetRedraw();
         updateInfo();
-        updateChannels();
+        //updateChannels();
     }
 }
 
 void GuideGrid::cursorUp()
 {
-    m_currentRow--;
-
-    if (m_currentRow < 0)
+    if (--m_currentRow < 0)
     {
         m_currentRow = 0;
         moveUpDown(kScrollUp);
     }
     else
     {
-        fillProgramRowInfos(m_currentRow);
+        fillProgramRowInfos(m_currentRow, true);
         m_guideGrid->SetRedraw();
         updateInfo();
-        updateChannels();
+        //updateChannels();
     }
 }
 
diff --git a/mythtv/programs/mythfrontend/guidegrid.h b/mythtv/programs/mythfrontend/guidegrid.h
index 1a6725c..0b82f6a 100644
--- a/mythtv/programs/mythfrontend/guidegrid.h
+++ b/mythtv/programs/mythfrontend/guidegrid.h
@@ -231,6 +231,7 @@ class GuideGrid : public ScheduleCommon, public JumpToChannelListener
     QString m_channelOrdering;
 
     QTimer *m_updateTimer; // audited ref #5318
+    QTime   m_tuneableCacheAge;
 
     int               m_changrpid;
     ChannelGroupList  m_changrplist;
-- 
1.7.9.5

