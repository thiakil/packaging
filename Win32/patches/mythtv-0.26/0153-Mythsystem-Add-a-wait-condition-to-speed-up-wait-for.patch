From 5da64524cd392867812a6ec82e85b5dbf868d49b Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sun, 9 Jun 2013 10:16:22 +0100
Subject: [PATCH 153/227] Mythsystem: Add a wait condition to speed up wait
 for completed children

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythbase/system-unix.cpp |    8 +++-----
 mythtv/libs/libmythbase/system-unix.h   |    1 +
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/mythtv/libs/libmythbase/system-unix.cpp b/mythtv/libs/libmythbase/system-unix.cpp
index 873a6d0..2c508d3 100644
--- a/mythtv/libs/libmythbase/system-unix.cpp
+++ b/mythtv/libs/libmythbase/system-unix.cpp
@@ -266,13 +266,10 @@ void MythSystemManager::run(void)
     // exit during shutdown.
     while( run_system )
     {
-        struct timespec ts;
-        ts.tv_sec = 0;
-        ts.tv_nsec = 100 * 1000 * 1000; // 100ms
-        nanosleep(&ts, NULL); // sleep 100ms
+        m_mapLock.lock();
+        m_wait.wait(&m_mapLock, m_pMap.isEmpty() ? 100 : 20);
 
         // check for any running processes
-        m_mapLock.lock();
 
         if( m_pMap.isEmpty() )
         {
@@ -442,6 +439,7 @@ void MythSystemManager::append(MythSystemUnix *ms)
     m_mapLock.lock();
     ms->IncrRef();
     m_pMap.insert(ms->m_pid, ms);
+    m_wait.wakeAll();
     m_mapLock.unlock();
 
     if( ms->GetSetting("UseStdin") )
diff --git a/mythtv/libs/libmythbase/system-unix.h b/mythtv/libs/libmythbase/system-unix.h
index c7436bd..95dd306 100644
--- a/mythtv/libs/libmythbase/system-unix.h
+++ b/mythtv/libs/libmythbase/system-unix.h
@@ -64,6 +64,7 @@ class MythSystemManager : public MThread
         QMutex     m_mapLock;
         bool       m_jumpAbort;
         QMutex     m_jumpLock;
+        QWaitCondition m_wait;
 };
 
 class MythSystemSignalManager : public MThread
-- 
1.7.9.5

