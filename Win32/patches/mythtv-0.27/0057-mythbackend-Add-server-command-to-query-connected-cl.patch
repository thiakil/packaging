From a88a390005976499632dadc8db59a58be37699d7 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Thu, 18 Apr 2013 19:32:50 +0100
Subject: [PATCH 057/207] mythbackend: Add server command to query connected
 clients

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/programs/mythbackend/filetransfer.cpp |    7 +++-
 mythtv/programs/mythbackend/filetransfer.h   |    2 ++
 mythtv/programs/mythbackend/mainserver.cpp   |   44 ++++++++++++++++++++++++++
 mythtv/programs/mythbackend/mainserver.h     |    1 +
 4 files changed, 53 insertions(+), 1 deletion(-)

diff --git a/mythtv/programs/mythbackend/filetransfer.cpp b/mythtv/programs/mythbackend/filetransfer.cpp
index 9f03bd4..7f014ba 100644
--- a/mythtv/programs/mythbackend/filetransfer.cpp
+++ b/mythtv/programs/mythbackend/filetransfer.cpp
@@ -234,7 +234,7 @@ long long FileTransfer::Seek(long long curpos, long long pos, int whence)
 
     Pause();
 
-    if (whence == SEEK_CUR)
+    if (whence == SEEK_CUR && curpos >= 0)
     {
         long long desired = curpos + pos;
         long long realpos = rbuffer->GetReadPosition();
@@ -268,4 +268,9 @@ void FileTransfer::SetTimeout(bool fast)
     rbuffer->SetOldFile(fast);
 }
 
+QString FileTransfer::GetFilename() const
+{
+    return rbuffer->GetFilename();
+}
+
 /* vim: set expandtab tabstop=4 shiftwidth=4: */
diff --git a/mythtv/programs/mythbackend/filetransfer.h b/mythtv/programs/mythbackend/filetransfer.h
index d8e5235..8b77a94 100644
--- a/mythtv/programs/mythbackend/filetransfer.h
+++ b/mythtv/programs/mythbackend/filetransfer.h
@@ -47,6 +47,8 @@ class FileTransfer : public ReferenceCounter
 
     void SetTimeout(bool fast);
 
+    QString GetFilename() const;
+
   private:
    ~FileTransfer();
 
diff --git a/mythtv/programs/mythbackend/mainserver.cpp b/mythtv/programs/mythbackend/mainserver.cpp
index 64d5094..3855b58 100644
--- a/mythtv/programs/mythbackend/mainserver.cpp
+++ b/mythtv/programs/mythbackend/mainserver.cpp
@@ -850,6 +850,13 @@ void MainServer::ProcessRequestWork(MythSocket *sock)
         LOG(VB_GENERAL, LOG_INFO ,"Reloading backend settings");
         HandleBackendRefresh(sock);
     }
+    else if (command == "QUERY_CLIENTS")
+    {
+        if (tokens.size() != 1)
+            LOG(VB_GENERAL, LOG_ERR, "Bad QUERY_CLIENTS");
+        else
+            HandleQueryClients(pbs);
+    }
     else if (command == "OK")
     {
         LOG(VB_GENERAL, LOG_ERR, "Got 'OK' out of sequence.");
@@ -6360,4 +6367,41 @@ void MainServer::SendSlaveDisconnectedEvent(
     gCoreContext->dispatch(me);
 }
 
+void MainServer::HandleQueryClients(PlaybackSock *pbsock)
+{
+    QStringList retlist;
+
+    sockListLock.lockForRead();
+
+    retlist << QString::number(playbackList.size() + fileTransferList.size());
+
+    for ( vector<PlaybackSock *>::iterator iter = playbackList.begin();
+        iter != playbackList.end(); ++iter)
+    {
+        PlaybackSock *pbs = *iter;
+
+        retlist << pbs->getHostname();
+        retlist << QString::number(pbs->isSlaveBackend() ? 1 : 0);
+        retlist << QString::number((int)pbs->eventsMode());
+        retlist << QString::number(pbs->getBlockShutdown());
+        retlist << pbs->getIP();
+    }
+
+    for ( vector<FileTransfer *>::iterator iter = fileTransferList.begin();
+        iter != fileTransferList.end(); ++iter)
+    {
+        FileTransfer *ft = *iter;
+        MythSocket *sock = ft->getSocket();
+
+        retlist << sock->GetPeerAddress().toString();
+        retlist << QString::number(2); // 2= file transfer client
+        retlist << QString::number(sock->GetSocketDescriptor());
+        retlist << QString::number(true);
+        retlist << ft->GetFilename();
+    }
+
+    sockListLock.unlock();
+
+    SendResponse(pbsock->getSocket(), retlist);
+}
 /* vim: set expandtab tabstop=4 shiftwidth=4: */
diff --git a/mythtv/programs/mythbackend/mainserver.h b/mythtv/programs/mythbackend/mainserver.h
index 32084f9..25fe694 100644
--- a/mythtv/programs/mythbackend/mainserver.h
+++ b/mythtv/programs/mythbackend/mainserver.h
@@ -226,6 +226,7 @@ class MainServer : public QObject, public MythSocketCBs
     void HandleBlockShutdown(bool blockShutdown, PlaybackSock *pbs);
     void HandleDownloadFile(const QStringList &command, PlaybackSock *pbs);
     void HandleSlaveDisconnectedEvent(const MythEvent &event);
+    void HandleQueryClients(PlaybackSock *);
 
     void SendResponse(MythSocket *pbs, QStringList &commands);
     void SendSlaveDisconnectedEvent(const QList<uint> &offlineEncoderIDs,
-- 
1.7.9.5

