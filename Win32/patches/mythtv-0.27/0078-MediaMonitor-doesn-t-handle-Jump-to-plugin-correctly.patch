From 81772c3a32f4369261ef656f37823754436c4dbc Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Mon, 30 Jan 2012 20:57:55 +0100
Subject: [PATCH 078/207] MediaMonitor doesn't handle 'Jump to plugin'
 correctly

In commit ed4d961aed836fade236d006b2797f0c044970de the call to
GetMythMainWindow()->JumpTo("Main Menu") was moved from
MediaMonitor::JumpToMediaHandler into the plugins MythMusic, MythVideo &
MythGallery.

However, JumpTo() doesn't complete synchronously, it calls
QCoreApplication::postEvent to do the work.  When the plugin starts its
event loop it finds the jump event and immediately exits without playing
the inserted media.

It is necessary to execute the following code after calling JumpTo():

     GetMythMainWindow()->JumpTo("Main Menu");
     QTime t; t.start();
     while (GetMythMainWindow()->IsExitingToMain() && t.elapsed() < 2000)
         qApp->processEvents(); // Ensure jump is executed before calling handler

Because of this it is preferable to keep the call to JumpTo() in
MediaMonitor::JumpToMediaHandler and append the above code rather than
replicate it in all plugins.

Ticket URL: <http://code.mythtv.org/trac/ticket/9537>

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythplugins/mythgallery/mythgallery/main.cpp |    1 -
 mythtv/libs/libmyth/mythmediamonitor.cpp     |   11 ++++++++++-
 mythtv/programs/mythfrontend/main.cpp        |    2 --
 3 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/mythplugins/mythgallery/mythgallery/main.cpp b/mythplugins/mythgallery/mythgallery/main.cpp
index d0037df..9b0b319 100644
--- a/mythplugins/mythgallery/mythgallery/main.cpp
+++ b/mythplugins/mythgallery/mythgallery/main.cpp
@@ -79,7 +79,6 @@ static void handleMedia(MythMediaDevice *dev)
 
     if (dev && dev->isUsable())
     {
-        GetMythMainWindow()->JumpTo("Main Menu");
         run(dev);
     }
 }
diff --git a/mythtv/libs/libmyth/mythmediamonitor.cpp b/mythtv/libs/libmyth/mythmediamonitor.cpp
index e6103e8..1ddfb60 100644
--- a/mythtv/libs/libmyth/mythmediamonitor.cpp
+++ b/mythtv/libs/libmyth/mythmediamonitor.cpp
@@ -366,6 +366,9 @@ bool MediaMonitor::RemoveDevice(const QString &dev)
     {
         if ((*it)->getDevicePath() == dev)
         {
+            // Ensure device gets an unmount
+            (*it)->checkMedia();
+
             if (m_UseCount[*it] == 0)
             {
                 m_UseCount.remove(*it);
@@ -667,6 +670,10 @@ void MediaMonitor::JumpToMediaHandler(MythMediaDevice* pMedia)
     // if user didn't cancel, selected = handlers.at(choice);
     int selected = 0;
 
+    GetMythMainWindow()->JumpTo("Main Menu");
+    QTime t; t.start();
+    while (GetMythMainWindow()->IsExitingToMain() && t.elapsed() < 2000)
+        qApp->processEvents(); // Ensure jump is executed before calling handler
     handlers.at(selected).callback(pMedia);
 }
 
@@ -690,7 +697,9 @@ void MediaMonitor::mediaStatusChanged(MythMediaStatus oldStatus,
     // This gets called from outside the main thread so we need
     // to post an event back to the main thread.
     // We now send events for all non-error statuses, so plugins get ejects
-    if (stat != MEDIASTAT_ERROR && stat != MEDIASTAT_UNKNOWN)
+    if (stat != MEDIASTAT_ERROR && stat != MEDIASTAT_UNKNOWN &&
+        // Don't send an event for a new device that's not mounted
+        !(oldStatus == MEDIASTAT_UNPLUGGED && stat == MEDIASTAT_NOTMOUNTED))
     {
         // Should we ValidateAndLock() first?
         QEvent *e = new MythMediaEvent(stat, pMedia);
diff --git a/mythtv/programs/mythfrontend/main.cpp b/mythtv/programs/mythfrontend/main.cpp
index fa790a9..1d01c99 100644
--- a/mythtv/programs/mythfrontend/main.cpp
+++ b/mythtv/programs/mythfrontend/main.cpp
@@ -808,10 +808,8 @@ static void handleDVDMedia(MythMediaDevice *dvd)
         case 0 : // Do nothing
             break;
         case 1 : // Display menu (mythdvd)*/
-            GetMythMainWindow()->JumpTo("Main Menu");
             break;
         case 2 : // play DVD or Blu-ray
-            GetMythMainWindow()->JumpTo("Main Menu");
             playDisc();
             break;
         case 3 : //Rip DVD
-- 
1.7.9.5

