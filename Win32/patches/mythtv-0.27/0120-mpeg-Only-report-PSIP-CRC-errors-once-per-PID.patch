From af7b30d902a19d5bdfbf13620d703bd170d857b1 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Thu, 9 Aug 2012 20:28:55 +0200
Subject: [PATCH 120/207] mpeg: Only report PSIP CRC errors once per PID

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythtv/mpeg/mpegstreamdata.cpp |   16 +++++++++++++---
 mythtv/libs/libmythtv/mpeg/mpegtables.cpp     |    9 ++++++++-
 2 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/mythtv/libs/libmythtv/mpeg/mpegstreamdata.cpp b/mythtv/libs/libmythtv/mpeg/mpegstreamdata.cpp
index be859a3..a8e512c 100644
--- a/mythtv/libs/libmythtv/mpeg/mpegstreamdata.cpp
+++ b/mythtv/libs/libmythtv/mpeg/mpegstreamdata.cpp
@@ -908,6 +908,11 @@ void MPEGStreamData::UpdateTimeOffset(uint64_t _si_utc_time)
 
 }
 
+static inline bool IsCA(uint id)
+{
+    return TableID::DVBCAbeg <= id && id <= TableID::DVBCAend;
+}
+
 #define DONE_WITH_PSIP_PACKET() { if (psip) delete psip; \
     if (morePSIPTables) goto HAS_ANOTHER_PSIP; else return; }
 
@@ -945,7 +950,9 @@ void MPEGStreamData::HandleTSTables(const TSPacket* tspacket)
          (TableID::PAT == psip->TableID()));
     if (!buggy && !psip->IsGood())
     {
-        LOG(VB_RECORD, LOG_ERR, LOC +
+        // To prevent a flood of log messages reduce loglevel for CA tables
+        // S*y/FreeSat have no CRC on PID 0xc0 type 0x82 (ECM priv)
+        LOG(VB_RECORD, (!IsCA(psip->TableID()) ? LOG_ERR : LOG_DEBUG),
             QString("PSIP packet failed CRC check. pid(0x%1) type(0x%2)")
                 .arg(tspacket->PID(),0,16).arg(psip->TableID(),0,16));
         DONE_WITH_PSIP_PACKET();
@@ -968,8 +975,11 @@ void MPEGStreamData::HandleTSTables(const TSPacket* tspacket)
 
     if (!psip->VerifyPSIP(!_have_CRC_bug))
     {
-        LOG(VB_RECORD, LOG_ERR, LOC + QString("PSIP table 0x%1 is invalid")
-            .arg(psip->TableID(),2,16,QChar('0')));
+        // To prevent a flood of log messages reduce loglevel for CA tables
+        // Freeview has no CRC on table types 0x82..0x84 (ECM priv)
+        LOG(VB_RECORD, (!IsCA(psip->TableID()) ? LOG_ERR : LOG_DEBUG),
+            QString("PSIP pid(0x%1) table 0x%2 is invalid")
+            .arg(tspacket->PID(),0,16).arg(psip->TableID(),2,16,QChar('0')));
         DONE_WITH_PSIP_PACKET();
     }
 
diff --git a/mythtv/libs/libmythtv/mpeg/mpegtables.cpp b/mythtv/libs/libmythtv/mpeg/mpegtables.cpp
index 4f7373a..03fde86 100644
--- a/mythtv/libs/libmythtv/mpeg/mpegtables.cpp
+++ b/mythtv/libs/libmythtv/mpeg/mpegtables.cpp
@@ -233,11 +233,18 @@ bool PSIPTable::HasSectionNumber(void) const
     return has_sn;
 }
 
+static inline bool IsCA(uint id)
+{
+    return TableID::DVBCAbeg <= id && id <= TableID::DVBCAend;
+}
+
 bool PSIPTable::VerifyPSIP(bool verify_crc) const
 {
     if (verify_crc && (CalcCRC() != CRC()))
     {
-        LOG(VB_SIPARSER, LOG_ERR,
+        // To prevent a flood of log messages reduce loglevel for CA tables
+        // Freeview has no CRC on table types 0x82..0x84 (ECM priv)
+        LOG(VB_SIPARSER, (!IsCA(TableID()) ? LOG_ERR : LOG_DEBUG),
             QString("PSIPTable: Failed CRC check 0x%1 != 0x%2 "
                     "for StreamID = 0x%3")
                 .arg(CRC(),0,16).arg(CalcCRC(),0,16).arg(StreamID(),0,16));
-- 
1.7.9.5

