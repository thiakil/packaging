From c611a19eb7e2f8434decfe5fc8013f195b0f85ed Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sun, 9 Jun 2013 10:16:22 +0100
Subject: [PATCH 124/207] Mythsystem: Add a wait condition to speed up wait
 for completed children

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythbase/mythsystemunix.cpp |    8 +++-----
 mythtv/libs/libmythbase/mythsystemunix.h   |    1 +
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/mythtv/libs/libmythbase/mythsystemunix.cpp b/mythtv/libs/libmythbase/mythsystemunix.cpp
index 48fad62..20ea5c2 100644
--- a/mythtv/libs/libmythbase/mythsystemunix.cpp
+++ b/mythtv/libs/libmythbase/mythsystemunix.cpp
@@ -278,13 +278,10 @@ void MythSystemLegacyManager::run(void)
     // exit during shutdown.
     while( run_system )
     {
-        struct timespec ts;
-        ts.tv_sec = 0;
-        ts.tv_nsec = 100 * 1000 * 1000; // 100ms
-        nanosleep(&ts, NULL); // sleep 100ms
+        m_mapLock.lock();
+        m_wait.wait(&m_mapLock, m_pMap.isEmpty() ? 100 : 20);
 
         // check for any running processes
-        m_mapLock.lock();
 
         if( m_pMap.isEmpty() )
         {
@@ -454,6 +451,7 @@ void MythSystemLegacyManager::append(MythSystemLegacyUnix *ms)
     m_mapLock.lock();
     ms->IncrRef();
     m_pMap.insert(ms->m_pid, ms);
+    m_wait.wakeAll();
     m_mapLock.unlock();
 
     if (ms->m_stdpipe[0] >= 0)
diff --git a/mythtv/libs/libmythbase/mythsystemunix.h b/mythtv/libs/libmythbase/mythsystemunix.h
index 33c979a..cc9383c 100644
--- a/mythtv/libs/libmythbase/mythsystemunix.h
+++ b/mythtv/libs/libmythbase/mythsystemunix.h
@@ -68,6 +68,7 @@ class MythSystemLegacyManager : public MThread
         QMutex     m_mapLock;
         bool       m_jumpAbort;
         QMutex     m_jumpLock;
+        QWaitCondition m_wait;
 };
 
 class MythSystemLegacySignalManager : public MThread
-- 
1.7.9.5

